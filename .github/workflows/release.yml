name: Release

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    python-release:
        runs-on: ubuntu-latest

        steps:
            - name: Check out repository
              uses: actions/checkout@v5

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.12"

            - name: Install project and tools
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .
                  pip install ruff mypy pytest build

            - name: Lint (ruff)
              run: ruff check .

            - name: Type check (mypy)
              run: mypy .

            - name: Run tests (pytest)
              run: pytest

            - name: Build distributions
              run: python -m build

    docker-release-smoke:
        runs-on: ubuntu-latest
        needs: python-release

        steps:
            - name: Check out repository
              uses: actions/checkout@v5

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  load: true
                  push: false
                  tags: ruisseau:release-${{ github.ref_name }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Smoke test CLI inside container
              run: docker run --rm ruisseau:release-${{ github.ref_name }} validate examples/example_dag.py
